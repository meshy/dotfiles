setopt INTERACTIVECOMMENTS
# Above command explicitly enables comments starting with `#` in zsh

############
# SETTINGS #
############

export EDITOR="nvim"
export MANPAGER="most"

# Disable zsh autocorrect
unsetopt correct_all

# Enable timestamps in history
setopt extendedhistory

# Back and forward through commands with CTRL-left/right
bindkey '5D' emacs-backward-word
bindkey '5C' emacs-forward-word
export WORDCHARS=''

# PEW replaces virtualenvwrapper
export PIPENV_SHELL_FANCY=1
export WORKON_HOME=~/venvs

# Go
export GOPATH=~/code/go

# PATH
if [[ "$SHLVL" == "1" ]]; then
    # Python (pip install --user)
    PATH="$HOME/.local/bin:$PATH"

    # Ruby
    eval "$(rbenv init -)"

    # Rust
    PATH="$HOME/.cargo/bin:$PATH"

    # Heroku
    PATH="/usr/local/heroku/bin:$PATH"

    # Go
    PATH="$PATH:$GOPATH/bin"
fi

# fzf (fuzzy finder)
# CTRL-R overrides history search.
# CTRL-T dumps the searched path into the current command
# ALT-C changes directory. This is a PITA.
export FZF_DEFAULT_COMMAND='ag -g ""'
source /usr/share/fzf/key-bindings.zsh
source /usr/share/fzf/completion.zsh

###########
# ALIASES #
###########

alias ccat='bat'
alias f='flake8 . --exclude=node_modules'
alias e='neomutt && notmuch new'
alias g='git'
alias m="make test"
alias mf="make testfast"
alias m2="make test VERBOSITY=2"
alias open='xdg-open'
alias pi="pip install"
alias t='tree -I "__pycache__|*.pyc" -C --dirsfirst'
alias vim='nvim'
alias v='nvim'
alias wo='pew workon'
alias fig='docker-compose'
alias reload='source ~/.zshrc'

# Alias hub to git, passing all args.
alias git=hub

# Bash Directory browsing shortcuts
alias k='tree'
alias ltr='ls -ltr'
alias r='screen -D -R'
alias ls='ls --color'
alias l='ls -lh'
alias ll='ls -la'

# Taskwarrior
alias ta='task add'

# Subpixel ordering for rotated monitors
alias vbgr="gsettings set org.gnome.settings-daemon.plugins.xsettings rgba-order 'vbgr'"
alias vrgb="gsettings set org.gnome.settings-daemon.plugins.xsettings rgba-order 'vbgr'"
alias rgb="gsettings set org.gnome.settings-daemon.plugins.xsettings rgba-order 'rgb'"
alias desk="vbgr"
alias laptop="rgb"

# How meta is this?!
alias cdd='cd ~/personal/dotfiles'

# Weather on the moon...
alias moon='curl wttr.in/moon'

# Dictionary/Thesaurus
alias dict="sdcv --color"

# Work around the infernal ghostscript
alias gs="git status"

# Display an image in the terminal. Only works in kitty.
alias img="kitty icat"

# Open a file in vim with CTRL-P
bindkey -s ^p '^Uvim $(fzf)^M'

#############
# FUNCTIONS #
#############

# Create a virtual environment.
function mkvenv3 {
    # Create a venv.
    pipenv install --three --keep-outdated
    # Work-around for https://github.com/pypa/pipenv/pull/1861
    echo $(pwd) > $(pipenv --venv)/.project
    # pip instead of pipenv because these shouldn't be stored in the Pipfile.
    pipenv run pip install neovim ipython
    # Activate the env.
    pipenv shell
}
function mkvenv2 {
    # Create a venv.
    pipenv install --two --keep-outdated
    # Work-around for https://github.com/pypa/pipenv/pull/1861
    echo $(pwd) > $(pipenv --venv)/.project
    # pip instead of pipenv because these shouldn't be stored in the Pipfile.
    pipenv run pip install neovim ipython
    # Activate the env.
    pipenv shell
}

# Install requirements with pip
function pp {
    defaultfile='requirements.txt'
    requirementsfile=${1:-$defaultfile}
    pi -r $requirementsfile
}

# Check the weather!
function weather {
    defaultcity='oxford'
    curl wttr.in/${1:-$defaultcity}\?m
}

function mkmodule {
    if [[ $# -eq 0 ]] ; then
        echo 'Module path required: `mkmodule path/to/module`'
    else
        mkdir $1
        touch $1/__init__.py
    fi
}


# Syntax highlighting needs to be at the end
source /usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh

#######
# FUN #
#######


if [[ "$SHLVL" == "1" ]]; then
    echo -n 'Todo: '
    task next
fi

# Default to ~/code/ directory
# Skip if already not in ~
if [ "$(pwd)" = "$HOME" ]; then
    cd ~/code/
fi
